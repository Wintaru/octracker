<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet" />
  <title>OC South - Pots FATE Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: #0f0f1a; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0f1a, #1a1a2e, #16213e);
      background-attachment: fixed;
      color: #e8e4dc;
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 24px;
    }
    #root { max-width: 520px; margin: 0 auto; }
    @media (max-width: 480px) {
      body { padding: 12px; }
    }
    button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const FATE_TIMES = [5, 35, 65, 95, 125, 155];
    const FATE_LOCATIONS = ["North", "South", "North", "South", "North", "South"];
    const TOLERANCE = 5;
    const SHARE_EPOCH = 1735689600000; // Jan 1 2025 UTC

    function encodeShareState(startRealTime, startInstanceTime, offset, uncertainty) {
      const t = Math.floor((startRealTime - SHARE_EPOCH) / 60000);
      const i = Math.round(startInstanceTime);
      const o = Math.round(offset * 10) + 300;
      const u = uncertainty >= 5 ? 0 : uncertainty >= 1 ? 1 : 2;
      return t.toString(36).padStart(4, '0')
           + i.toString(36).padStart(2, '0')
           + o.toString(36).padStart(2, '0')
           + u.toString(36);
    }

    function decodeShareState(code) {
      if (!code || code.length !== 9) return null;
      const t = parseInt(code.slice(0, 4), 36);
      const i = parseInt(code.slice(4, 6), 36);
      const o = parseInt(code.slice(6, 8), 36);
      const u = parseInt(code.slice(8, 9), 36);
      if ([t, i, o, u].some(isNaN)) return null;
      return {
        startRealTime: t * 60000 + SHARE_EPOCH,
        startInstanceTime: i,
        offset: (o - 300) / 10,
        uncertainty: u === 0 ? 5 : u === 1 ? 1 : 0.5,
      };
    }

    function fmtShort(mins) {
      if (mins < 0) return "—";
      const m = Math.floor(mins);
      const s = Math.round((mins - m) * 60);
      return `${m}:${s.toString().padStart(2, "0")}`;
    }

    function fmtTime(mins) {
      const d = new Date(Date.now() + mins * 60000);
      return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    }

    function parseMins(h, m, s) {
      return (parseInt(h) || 0) * 60 + (parseInt(m) || 0) + (parseInt(s) || 0) / 60;
    }

    function FateTracker() {
      const [playerMin, setPlayerMin] = useState("");
      const [offset, setOffset] = useState(0);
      const [uncertainty, setUncertainty] = useState(TOLERANCE);
      const [calibrated, setCalibrated] = useState(false);
      const [calibCount, setCalibCount] = useState(0);
      const [defeatedIdx, setDefeatedIdx] = useState(null);
      const [startRealTime, setStartRealTime] = useState(null);
      const [startInstanceTime, setStartInstanceTime] = useState(null);
      const [tracking, setTracking] = useState(false);
      const [now, setNow] = useState(Date.now());
      const [statusMsg, setStatusMsg] = useState("");

      useEffect(() => {
        const hash = window.location.hash.slice(1);
        if (hash) {
          const state = decodeShareState(hash);
          if (state) {
            setStartRealTime(state.startRealTime);
            setStartInstanceTime(state.startInstanceTime);
            setOffset(state.offset);
            setUncertainty(state.uncertainty);
            setCalibrated(state.uncertainty < 5);
            setCalibCount(state.uncertainty <= 0.5 ? 2 : state.uncertainty <= 1 ? 1 : 0);
            setTracking(true);
            setStatusMsg("Loaded from shared link");
          }
        }
      }, []);

      useEffect(() => {
        if (tracking && startRealTime) {
          const code = encodeShareState(startRealTime, startInstanceTime, offset, uncertainty);
          history.replaceState(null, '', '#' + code);
        } else if (!tracking) {
          history.replaceState(null, '', window.location.pathname);
        }
      }, [tracking, startRealTime, startInstanceTime, offset, uncertainty]);

      useEffect(() => {
        const interval = setInterval(() => setNow(Date.now()), 1000);
        return () => clearInterval(interval);
      }, []);

      const currentInstanceTime = useCallback(() => {
        if (!tracking || !startRealTime) return 0;
        return startInstanceTime + (now - startRealTime) / 60000;
      }, [tracking, startRealTime, startInstanceTime, now]);

      const getSchedule = useCallback(() => {
        const instTime = currentInstanceTime();
        return FATE_TIMES.map((t, i) => {
          const adj = t + offset;
          const remaining = adj - instTime;
          const earlyRemaining = remaining - uncertainty;
          const lateRemaining = remaining + uncertainty;
          let status = "passed";
          if (earlyRemaining > 0.15) status = "upcoming";
          else if (lateRemaining > -0.5 && i !== defeatedIdx) status = "window";
          return { num: i + 1, time: adj, loc: FATE_LOCATIONS[i], remaining, earlyRemaining, lateRemaining, status };
        });
      }, [currentInstanceTime, offset, uncertainty, defeatedIdx]);

      const nextFate = useCallback(() => {
        return getSchedule().find((f) => f.status === "upcoming" || f.status === "window");
      }, [getSchedule]);

      function handleStart(location) {
        const mins = parseInt(playerMin) || 0;
        const firstTime = location === "North" ? 5 : 35;
        let instanceTime = firstTime - mins;
        while (instanceTime < 0) instanceTime += 60;
        setStartInstanceTime(instanceTime);
        setStartRealTime(Date.now());
        setTracking(true);
        setOffset(0);
        setUncertainty(TOLERANCE);
        setCalibrated(false);
        setCalibCount(0);
        setStatusMsg(`Tracking from ${location} estimate (\u00b15 min window)`);
      }

      function handleCalibrate(location) {
        const instTime = currentInstanceTime();
        let bestIdx = 0;
        let bestDist = Infinity;
        for (let i = 0; i < FATE_TIMES.length; i++) {
          if (FATE_LOCATIONS[i] !== location) continue;
          const dist = Math.abs(FATE_TIMES[i] + offset - instTime);
          if (dist < bestDist) { bestDist = dist; bestIdx = i; }
        }

        const newOffset = instTime - FATE_TIMES[bestIdx];
        setDefeatedIdx(bestIdx);
        setOffset(newOffset);
        const newCount = calibCount + 1;
        setCalibCount(newCount);

        if (newCount === 1) {
          setUncertainty(1);
          setCalibrated(true);
          setStatusMsg(`Calibrated to ${location} spawn! Shifted by ${newOffset > 0 ? "+" : ""}${newOffset.toFixed(1)} min. Now \u00b11 min.`);
        } else {
          setUncertainty(0.5);
          setStatusMsg(`Re-calibrated to ${location} spawn! Precision: \u00b130 sec.`);
        }
      }

      function handleReset() {
        setTracking(false);
        setPlayerMin("");
        setOffset(0); setUncertainty(TOLERANCE);
        setCalibrated(false); setCalibCount(0); setDefeatedIdx(null);
        setStartRealTime(null); setStartInstanceTime(null);
        setStatusMsg("");
      }

      function handleShare() {
        const code = encodeShareState(startRealTime, startInstanceTime, offset, uncertainty);
        const url = `${window.location.origin}/${code}`;
        navigator.clipboard.writeText(url).then(() => {
          setStatusMsg("Link copied to clipboard!");
        }).catch(() => {
          setStatusMsg(url);
        });
      }

      const instTime = currentInstanceTime();
      const schedule = getSchedule();
      const next = nextFate();
      const afterNext = schedule.filter(f => (f.status === "upcoming" || f.status === "window") && f !== next)[0] || null;

      useEffect(() => {
        if (next && tracking) {
          const mins = Math.max(0, Math.ceil(next.remaining));
          document.title = `${mins}m - ${next.loc} Pots`;
        } else if (tracking) {
          document.title = "No more FATEs";
        } else {
          document.title = "OC South - Pots FATE Tracker";
        }
      }, [next, tracking, now]);
      const confidenceColor = uncertainty <= 0.5 ? "#34d399" : uncertainty <= 1 ? "#6ee7b7" : uncertainty <= 3 ? "#fcd34d" : "#fdba74";
      const confidenceLabel = uncertainty <= 0.5 ? "High" : uncertainty <= 1 ? "Good" : uncertainty <= 3 ? "Fair" : "Estimate";

      const cardStyle = { background: "rgba(16,33,62,0.6)", borderRadius: 4, padding: 16, border: "1px solid rgba(191,163,76,0.25)", boxShadow: "inset 0 1px 0 rgba(191,163,76,0.08)" };
      const inputStyle = { width: 64, padding: "10px 8px", borderRadius: 4, border: "1px solid rgba(191,163,76,0.3)", background: "rgba(16,33,62,0.8)", color: "#e8e4dc", fontSize: 18, textAlign: "center", outline: "none" };
      const btnPrimary = { width: "100%", padding: "12px 16px", borderRadius: 4, border: "1px solid rgba(191,163,76,0.2)", background: "linear-gradient(135deg, #7c3aed, #a855f7)", color: "#fff", fontSize: 14, fontWeight: 600, cursor: "pointer" };
      const btnNorth = { flex: 1, padding: "16px 16px", borderRadius: 4, border: "1px solid rgba(191,163,76,0.35)", borderTop: "2px solid #5b7cd8", background: "linear-gradient(180deg, rgba(30,50,90,0.95), rgba(18,30,60,0.95))", color: "#93c5fd", fontSize: 15, fontWeight: 700, cursor: "pointer", boxShadow: "inset 0 1px 0 rgba(91,124,216,0.15), 0 2px 4px rgba(0,0,0,0.3)", fontFamily: "'Cinzel', serif", letterSpacing: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4 };
      const btnSouth = { flex: 1, padding: "16px 16px", borderRadius: 4, border: "1px solid rgba(191,163,76,0.35)", borderTop: "2px solid #d4a040", background: "linear-gradient(180deg, rgba(65,38,18,0.95), rgba(45,25,12,0.95))", color: "#fdba74", fontSize: 15, fontWeight: 700, cursor: "pointer", boxShadow: "inset 0 1px 0 rgba(212,160,64,0.15), 0 2px 4px rgba(0,0,0,0.3)", fontFamily: "'Cinzel', serif", letterSpacing: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4 };

      return (
        <div>
          <h1 style={{ fontSize: 24, fontWeight: 700, textAlign: "center", marginBottom: 2, fontFamily: "'Cinzel', serif", background: "linear-gradient(180deg, #d4c078, #bfa34c)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>
            Occult Crescent South
          </h1>
          <p style={{ textAlign: "center", fontSize: 13, color: "#a9a6a0", marginBottom: 12, fontFamily: "'Cinzel', serif", letterSpacing: 1 }}>
            Pots FATE Tracker
          </p>
          <div style={{ height: 1, background: "linear-gradient(to right, transparent, rgba(191,163,76,0.5), transparent)", marginBottom: 20 }} />

          {!tracking ? (
            <div style={cardStyle}>
              <label style={{ fontSize: 14, color: "#a9a6a0", marginBottom: 12, display: "block" }}>
                Estimated minutes until next Pots FATE:
              </label>
              <div style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 8 }}>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                  <input type="number" min="0" max="60" placeholder="0" value={playerMin} onChange={(e) => setPlayerMin(e.target.value)} style={{ ...inputStyle, width: 100 }} />
                  <span style={{ fontSize: 11, color: "#6e6b65", marginTop: 4 }}>minutes</span>
                </div>
              </div>
              <p style={{ fontSize: 11, color: "#6e6b65", marginBottom: 16, lineHeight: 1.5 }}>
                Enter your best guess, then tap which location it will be. Predictions start ±5 min — calibrate when a FATE spawns to tighten it.
              </p>
              <div style={{ display: "flex", gap: 10 }}>
                <button onClick={() => handleStart("North")} style={btnNorth}>
                  <span style={{ fontSize: 18 }}>{"\u2726"}</span>
                  <span>North Pots</span>
                </button>
                <button onClick={() => handleStart("South")} style={btnSouth}>
                  <span style={{ fontSize: 18 }}>{"\u2726"}</span>
                  <span>South Pots</span>
                </button>
              </div>
            </div>
          ) : (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16, padding: "10px 16px", borderRadius: 4, background: "rgba(16,33,62,0.4)", border: "1px solid rgba(191,163,76,0.15)" }}>
                <div>
                  <div style={{ fontSize: 11, color: "#a9a6a0" }}>Time Tracked</div>
                  <div style={{ fontSize: 20, fontWeight: 700, color: "#d4c078" }}>{fmtShort(instTime)}</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 11, color: "#a9a6a0" }}>Accuracy</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: confidenceColor }}>
                    {confidenceLabel} <span style={{ fontWeight: 400, fontSize: 12 }}>(±{uncertainty <= 1 ? `${Math.round(uncertainty * 60)}s` : `${uncertainty}m`})</span>
                  </div>
                </div>
              </div>

              {next ? (
                <div style={{
                  borderRadius: 4, padding: 24, marginBottom: 16, textAlign: "center",
                  background: next.loc === "North" ? "linear-gradient(135deg, rgba(59,130,246,0.12), rgba(59,130,246,0.03))" : "linear-gradient(135deg, rgba(249,115,22,0.12), rgba(249,115,22,0.03))",
                  border: `1px solid ${next.loc === "North" ? "rgba(59,130,246,0.25)" : "rgba(249,115,22,0.25)"}`,
                  boxShadow: "inset 0 1px 0 rgba(191,163,76,0.06)",
                }}>
                  <div style={{ fontSize: 12, color: "#a9a6a0", marginBottom: 4 }}>Next Pots FATE</div>
                  <div style={{ fontSize: 36, fontWeight: 700, marginBottom: 10, color: next.loc === "North" ? "#93c5fd" : "#fdba74", fontFamily: "'Cinzel', serif" }}>
                    {next.loc}
                  </div>
                  {next.status === "window" ? (
                    <div>
                      <div style={{ fontSize: 26, fontWeight: 700, color: "#fbbf24" }}>{calibrated ? "\u26a1 Active now!" : "\u26a1 Could be active now!"}</div>
                      <div style={{ fontSize: 12, color: "#a9a6a0", marginTop: 4 }}>{calibrated ? "Confirmed spawn \u2014 watch for it!" : `Window open \u2014 up to ${fmtShort(Math.max(0, next.lateRemaining))} from now`}</div>
                    </div>
                  ) : (
                    <div>
                      <div style={{ fontSize: 13, color: "#a9a6a0", marginBottom: 4 }}>Spawns in</div>
                      <div style={{ display: "flex", justifyContent: "center", alignItems: "baseline", gap: 6 }}>
                        <span style={{ fontSize: 12, color: confidenceColor }}>{fmtShort(Math.max(0, next.earlyRemaining))}</span>
                        <span style={{ fontSize: 32, fontWeight: 700, color: "#e8e4dc" }}>{fmtShort(Math.max(0, next.remaining))}</span>
                        <span style={{ fontSize: 12, color: confidenceColor }}>{fmtShort(Math.max(0, next.lateRemaining))}</span>
                      </div>
                      <div style={{ fontSize: 11, color: "#a9a6a0", marginTop: 4 }}>early — best guess — late</div>
                      <div style={{ fontSize: 14, color: "#d4c078", marginTop: 10 }}>~{fmtTime(next.remaining)}</div>
                      <div style={{ marginTop: 14, height: 5, borderRadius: 2, background: "rgba(191,163,76,0.1)", position: "relative", overflow: "hidden" }}>
                        {(() => {
                          const total = 30;
                          const center = Math.max(0, Math.min(next.remaining, total));
                          const early = Math.max(0, center - uncertainty);
                          const late = Math.min(total, center + uncertainty);
                          return <div style={{ position: "absolute", left: `${(early / total) * 100}%`, width: `${((late - early) / total) * 100}%`, height: "100%", borderRadius: 2, background: `linear-gradient(90deg, ${confidenceColor}44, ${confidenceColor}aa, ${confidenceColor}44)` }} />;
                        })()}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div style={{ ...cardStyle, background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.25)", textAlign: "center", color: "#fca5a5", marginBottom: 16 }}>
                  No more FATEs expected this instance.
                </div>
              )}

              {afterNext && (
                <div style={{
                  ...cardStyle, marginBottom: 16, display: "flex", justifyContent: "space-between", alignItems: "center",
                }}>
                  <div>
                    <div style={{ fontSize: 11, color: "#a9a6a0" }}>After That</div>
                    <div style={{ fontSize: 20, fontWeight: 700, color: afterNext.loc === "North" ? "#93c5fd" : "#fdba74", fontFamily: "'Cinzel', serif" }}>{afterNext.loc}</div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 18, fontWeight: 600, color: "#e8e4dc" }}>{fmtShort(Math.max(0, afterNext.remaining))}</div>
                    <div style={{ fontSize: 12, color: "#a9a6a0" }}>~{fmtTime(afterNext.remaining)}</div>
                  </div>
                </div>
              )}

              <div style={{ ...cardStyle, marginBottom: 16 }}>
                <div style={{ fontSize: 13, fontWeight: 600, color: "#d4c078", marginBottom: 6 }}>
                  {calibrated ? "Re-Calibrate" : "Calibrate"} — FATE Just Spawned?
                </div>
                <p style={{ fontSize: 12, color: "#6e6b65", marginBottom: 14, lineHeight: 1.5 }}>
                  When a FATE spawns, tap the matching location button to sync the schedule.
                </p>
                <div style={{ display: "flex", gap: 10 }}>
                  <button onClick={() => handleCalibrate("North")} style={btnNorth}>
                    <span style={{ fontSize: 18 }}>{"\u2726"}</span>
                    <span>North Spawned</span>
                  </button>
                  <button onClick={() => handleCalibrate("South")} style={btnSouth}>
                    <span style={{ fontSize: 18 }}>{"\u2726"}</span>
                    <span>South Spawned</span>
                  </button>
                </div>
                {statusMsg && <p style={{ fontSize: 11, color: confidenceColor, marginTop: 10 }}>{statusMsg}</p>}
              </div>

              <div style={{ display: "flex", gap: 10 }}>
                <button onClick={handleShare} style={{ ...btnPrimary, flex: 1, background: "linear-gradient(135deg, #8c7635, #bfa34c)", border: "1px solid rgba(191,163,76,0.4)" }}>Share Link</button>
                <button onClick={handleReset} style={{ ...btnPrimary, flex: 1, background: "rgba(16,33,62,0.6)", color: "#a9a6a0", border: "1px solid rgba(191,163,76,0.15)" }}>Reset</button>
              </div>
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<FateTracker />);
  </script>
</body>
</html>
